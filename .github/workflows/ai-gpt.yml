name: ai-gpt-issue-orchestra

on:
  issues:
    types:
      - opened
      - labeled

jobs:
  gpt_assistant:
    # ãƒ©ãƒ™ãƒ«ãŒ ai-gpt ã®ã¨ãã ã‘å‹•ã
    if: github.event.label.name == 'ai-gpt'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Call OpenAI and comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const { owner, repo } = context.repo;

            const title = issue.title || "";
            const body = issue.body || "";

            const prompt = `
You are "GPT", the AI project producer for Taka, a Japanese cultural producer and AI orchestrator.
Read the following GitHub Issue (title + body) and respond in Japanese.

Do three things:

1. ã‚¿ã‚¹ã‚¯ã®è¦ç´„ï¼ˆ2ã€œ3è¡Œï¼‰
2. ã‚¿ã‚¹ã‚¯ã®åˆ†è§£ï¼ˆç•ªå·ä»˜ãã‚¹ãƒ†ãƒƒãƒ— 3ã€œ7å€‹ï¼‰
3. ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆè¦–ç‚¹ã‹ã‚‰ã®æ³¨æ„ç‚¹ã¨ã€ã‚ˆã‚Šã‚ˆãé€²ã‚ã‚‹ãŸã‚ã®ææ¡ˆ

å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:

## ğŸ“ è¦ç´„
...

## âœ… ã‚¿ã‚¹ã‚¯åˆ†è§£
1. ...
2. ...

## ğŸ‘€ ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆã‹ã‚‰ã®ææ¡ˆ
- ...

Issue title:
${title}

Issue body:
${body}
            `.trim();

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                messages: [
                  {
                    role: "system",
                    content: "You are a warm, strategic Japanese assistant called GPT, helping Taka orchestrate AI and projects."
                  },
                  {
                    role: "user",
                    content: prompt
                  }
                ],
                temperature: 0.4
              })
            });

            if (!response.ok) {
              const text = await response.text();
              console.log("OpenAI API error:", response.status, text);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `âš ï¸ GPTå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆstatus: ${response.status}ï¼‰ã€‚è¨­å®šã‚„APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
              return;
            }

            const data = await response.json();
            const reply =
              (data.choices &&
                data.choices[0] &&
                data.choices[0].message &&
                data.choices[0].message.content) ||
              "GPTã‹ã‚‰ã®å¿œç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: reply.trim(),
            });
