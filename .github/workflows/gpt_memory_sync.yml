name: GPT memory sync

on:
  issues:
    types: [labeled]

# ★ GITHUB_TOKEN に「書き込み権限」を明示
permissions:
  contents: write

jobs:
  gpt_memory_sync:
    # ラベルが gpt-memory のときだけ動く
    if: github.event.label.name == 'gpt-memory'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare memory directory
        run: mkdir -p memory/gpt

      - name: Append simple memory log
        run: |
          FILE="memory/gpt/issue-log.md"
          {
            echo "## Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            echo "- URL: ${{ github.event.issue.html_url }}"
            echo "- Label: ${{ github.event.label.name }}"
            echo "- Synced at: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
            echo ""
          } >> "$FILE"

          echo "---- Current memory/gpt contents ----"
          ls -la memory/gpt
          echo "------------------------------------"

      - name: Commit changes (if any)
        run: |
          git config user.name "taka-gpt-memory-bot"
          git config user.email "actions@github.com"

          git add memory/gpt || true

          echo "---- git status before commit ----"
          git status
          echo "----------------------------------"

          git commit -m "Update GPT memory log for issue #${{ github.event.issue.number }}" \
            || echo "No changes to commit"

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 一応リモートを最新化
          git pull --rebase origin ${{ github.ref_name }} || echo "Nothing to pull"

          echo "---- pushing to origin ${{ github.ref_name }} ----"
          git push origin HEAD:${{ github.ref_name }}
