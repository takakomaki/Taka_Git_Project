name: ai-gpt-issue-orchestra

on:
  issues:
    types: [opened, edited, labeled]

jobs:
  gpt_assistant:
    runs-on: ubuntu-latest

    steps:
      - name: Check label and decide whether to run
        id: check_label
        run: |
          echo "Labels: ${{ toJson(github.event.issue.labels.*.name) }}"
          if [[ "${{ toJson(github.event.issue.labels.*.name) }}" == *"gpt-memory"* ]]; then
            echo "run_job=true" >> $GITHUB_OUTPUT
          else
            echo "run_job=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check_label.outputs.run_job == 'true'
        uses: actions/checkout@v4

      - name: Save issue to memory/gpt
        if: steps.check_label.outputs.run_job == 'true'
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          TITLE="${{ github.event.issue.title }}"
          URL="${{ github.event.issue.html_url }}"

          mkdir -p memory/gpt

          FILE="memory/gpt/issue-${ISSUE_NUMBER}.md"

          {
            echo "# Issue #${ISSUE_NUMBER} - ${TITLE}"
            echo
            echo "- URL: ${URL}"
            echo "- Updated at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo
            echo "## Latest event payload"
            echo '```json'
            echo '${{ toJson(github.event) }}'
            echo '```'
          } > "${FILE}"

      - name: Commit & push memory file
        if: steps.check_label.outputs.run_job == 'true'
        run: |
          git config user.name "ai-orchestra-bot"
          git config user.email "ai-orchestra-bot@example.com"

          git add memory/gpt/issue-${{ github.event.issue.number }}.md
          git commit -m "Add/update GPT memory for issue #${{ github.event.issue.number }}" || echo "No changes to commit"
          git push
