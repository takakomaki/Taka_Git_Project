name: GPT memory sync

on:
  issues:
    types:
      - labeled

permissions:
  contents: write

jobs:
  gpt_assistant:
    # ラベルに gpt-memory が付いたときだけ動かす
    if: contains(join(github.event.issue.labels.*.name, ','), 'gpt-memory')
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Append / overwrite memory file for this issue
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_USER: ${{ github.event.issue.user.login }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
        run: |
          mkdir -p memory/gpt

          FILE="memory/gpt/issue-${ISSUE_NUMBER}.md"

          cat > "$FILE" <<EOF
# Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

- URL: ${ISSUE_URL}
- Author: ${ISSUE_USER}
- Labels: ${ISSUE_LABELS}
- Logged at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

---

${{ github.event.issue.body }}

EOF

      - name: Check for changes
        id: git_diff
        run: |
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.git_diff.outputs.no_changes == 'false'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add memory/gpt
          git commit -m "Update GPT memory for issue #${{ github.event.issue.number }}"

      - name: Push changes
        if: steps.git_diff.outputs.no_changes == 'false'
        run: |
          git push origin "${GITHUB_REF#refs/heads/}"
