name: AI Orchestra Issues

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: write

jobs:
  # 1ï¸âƒ£ GPTã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼šã‚¿ã‚¹ã‚¯åˆ†è§£ï¼‹ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆ
  gpt_assistant:
    if: github.event.label.name == 'ai-gpt'
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Call OpenAI and comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const { owner, repo } = context.repo;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: "ğŸ¤– ai-gpt ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ã‚¿ã‚¹ã‚¯æ•´ç†ã¨ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆã‚’è¡Œã„ã¾ã™ã€‚"
            });

            const title = issue.title || "";
            const body = issue.body || "";

            const prompt =
              "You are \\\"GPT\\\", the AI project producer for Taka, a Japanese cultural producer and AI orchestrator.\n" +
              "Read the following GitHub Issue (title + body) and respond in Japanese.\n\n" +
              "Do three things:\n\n" +
              "1. ã‚¿ã‚¹ã‚¯ã®è¦ç´„ï¼ˆ2ã€œ3è¡Œï¼‰\n" +
              "2. ã‚¿ã‚¹ã‚¯ã®åˆ†è§£ï¼ˆç•ªå·ä»˜ãã‚¹ãƒ†ãƒƒãƒ— 3ã€œ7å€‹ï¼‰\n" +
              "3. ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆè¦–ç‚¹ã‹ã‚‰ã®æ³¨æ„ç‚¹ã¨ã€ã‚ˆã‚Šã‚ˆãé€²ã‚ã‚‹ãŸã‚ã®ææ¡ˆ\n\n" +
              "å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:\n\n" +
              "## ğŸ“ è¦ç´„\n" +
              "...\n\n" +
              "## âœ… ã‚¿ã‚¹ã‚¯åˆ†è§£\n" +
              "1. ...\n" +
              "2. ...\n\n" +
              "## ğŸ‘€ ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆã‹ã‚‰ã®ææ¡ˆ\n" +
              "- ...\n\n" +
              "Issue title:\n" +
              title +
              "\n\nIssue body:\n" +
              body;

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                messages: [
                  {
                    role: "system",
                    content: "You are a warm, strategic Japanese assistant called GPT, helping Taka orchestrate AI and projects."
                  },
                  {
                    role: "user",
                    content: prompt
                  }
                ],
                temperature: 0.4
              })
            });

            if (!response.ok) {
              const text = await response.text();
              console.log("OpenAI API error:", response.status, text);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `âš ï¸ GPTå‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆstatus: ${response.status}ï¼‰ã€‚è¨­å®šã‚„APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
              return;
            }

            const data = await response.json();
            const reply =
              (data.choices &&
                data.choices[0] &&
                data.choices[0].message &&
                data.choices[0].message.content) ||
              "GPTã‹ã‚‰ã®å¿œç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: reply.trim(),
            });

  # 2ï¸âƒ£ GPT memory syncï¼šIssueã‚’ã€Œè¨˜æ†¶ãƒ•ã‚¡ã‚¤ãƒ«ã€ã«è¿½è¨˜
  gpt_memory_sync:
    if: github.event.label.name == 'gpt-memory'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare memory directory
        run: mkdir -p memory/gpt

      - name: Append simple memory log
        run: |
          FILE="memory/gpt/issue-log.md"
          {
            echo "## Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            echo "- URL: ${{ github.event.issue.html_url }}"
            echo "- Label: ${{ github.event.label.name }}"
            echo "- Synced at: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
            echo ""
          } >> "$FILE"

          echo "---- Current memory/gpt contents ----"
          ls -la memory/gpt
          echo "------------------------------------"

      - name: Commit changes if needed
        run: |
          git config user.name "taka-gpt-memory-bot"
          git config user.email "actions@github.com"

          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected. Committing..."
            git add memory/gpt
            git commit -m "Update GPT memory log for issue #${{ github.event.issue.number }}"
          else
            echo "No changes to commit."
          fi

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch is: $CURRENT_BRANCH"

          git pull --rebase origin "$CURRENT_BRANCH" || echo "Nothing to pull"

          echo "---- pushing to origin $CURRENT_BRANCH ----"
          git push origin HEAD:"$CURRENT_BRANCH" || echo "Nothing to push"

  # 3ï¸âƒ£ Orchestra Brief ç”Ÿæˆï¼šä»–AIã«æ¸¡ã™ä¼šè­°ãƒ–ãƒªãƒ¼ãƒ•
  gpt_orchestra_brief:
    if: github.event.label.name == 'orchestra-brief'
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Generate Orchestra Brief and comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const { owner, repo } = context.repo;

            const title = issue.title || "";
            const body = issue.body || "";

            const prompt =
              "You are \\\"GPT\\\", conductor of the AI Orchestra for Taka.\n" +
              "Create an 'Orchestra Brief v0.1' in Japanese Markdown that other AIs (Claude, Gemini, Grok, DeepSeek) can read to join this conversation.\n\n" +
              "å¿…ãšæ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚ã¦ãã ã•ã„ï¼š\n" +
              "- Topic\n- Background\n- Goal\n- Constraints\n- Rolesï¼ˆGPT, Claude, Gemini, Grok, DeepSeek ã®æœŸå¾…å½¹å‰²ï¼‰\n- Questions to Youï¼ˆä»–AIã¸ã®è³ªå• 3ã€œ5å€‹ï¼‰\n\n" +
              "Issue title:\n" + title +
              "\n\nIssue body:\n" + body;

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: "gpt-4.1-mini",
                messages: [
                  {
                    role: "system",
                    content: "You are a warm, structured assistant called GPT, creating AI Orchestra Briefs."
                  },
                  {
                    role: "user",
                    content: prompt
                  }
                ],
                temperature: 0.4
              })
            });

            if (!response.ok) {
              const text = await response.text();
              console.log("OpenAI API error:", response.status, text);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: `âš ï¸ Orchestra Briefç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆstatus: ${response.status}ï¼‰ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
              });
              return;
            }

            const data = await response.json();
            const brief =
              (data.choices &&
                data.choices[0] &&
                data.choices[0].message &&
                data.choices[0].message.content) ||
              "GPTã‹ã‚‰ã®Orchestra BriefãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: "ğŸ¼ ä»¥ä¸‹ãŒã“ã®Issueã® Orchestra Brief v0.1 ã§ã™ã€‚ä»–AIã«ãã®ã¾ã¾å…±æœ‰ã§ãã¾ã™ã€‚\n\n" + brief.trim(),
            });
